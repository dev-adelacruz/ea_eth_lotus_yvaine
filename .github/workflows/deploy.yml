name: Deploy Trading Bot to AWS EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ðŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /home/ubuntu/ea_eth
          
          # Stash any local changes and pull latest code
          git stash
          git pull origin main
          
          # Install dependencies
          echo "Installing dependencies..."
          bundle install --path vendor/bundle
          
          # Restart the trading bot service
          echo "Restarting trading bot service..."
          sudo bash -c '> /home/ubuntu/ea_eth/bot.log'
          sudo bash -c '> /home/ubuntu/ea_eth/bot-buds.log'
          sudo systemctl restart trading-bot.service
          sudo systemctl restart trading-bot-buds.service
          
          # Verify service is running
          echo "Checking service status..."
          sudo systemctl status trading-bot.service --no-pager
          sudo systemctl status trading-bot-buds.service --no-pager
          
          echo "âœ… Deployment completed successfully!"
